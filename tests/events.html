<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.1//EN" "http://www.w3.org/TR/xhtml11/DTD/xhtml11.dtd">
<html xmlns="http://www.w3.org/1999/xhtml" xml:lang="fr">
<head>
	<meta http-equiv="X-UA-Compatible" content="IE=edge" />
</head>
<body>

<script type="text/javascript" src="jsunit.js"></script>
<script type="text/javascript" src="loader.js"></script>
<script type="text/javascript">
load_alpha('..');
</script>

<script type="text/javascript">

function new_input()
{
  var input = document.createElement('input');
  document.body.appendChild(input);

  input.destroy = function() {
    this.parentNode.removeChild(this);
  }

  return input;
}


jsUnit.add("Event must be prototyped", function() {
  jsUnit.assertObject(Event.prototype);
});

jsUnit.add("window.addEventListener must be defined", function() {
  jsUnit.assertFunction(window.addEventListener);
});
jsUnit.add("document.body.addEventListener must be defined", function() {
  jsUnit.assertFunction(document.body.addEventListener);
});
jsUnit.add("document.documentElement.addEventListener must be defined", function() {
  jsUnit.assertFunction(document.documentElement.addEventListener);
});

jsUnit.add("Element.addEventListener() with one listener", function()
{
  var elm = new_input(), test;
  elm.addEventListener('click', function(evt) { test = true; }, false);
  elm.click();
  jsUnit.assertTrue(test);
  elm.parentNode.removeChild(elm);
});

jsUnit.add("Element.addEventListener() with many listeners", function()
{
  var elm = new_input(), test = null;
  elm.addEventListener('click', function(evt) { test = true;  }, false);
  elm.addEventListener('click', function(evt) { test = false; }, false);
  elm.click();
  jsUnit.assertFalse(test);
  elm.parentNode.removeChild(elm);
});

jsUnit.add("Element.removeEventListener()", function()
{
  var elm  = new_input();
  var test = null;

  var fn = function() {
    test = true;
  }

  elm.addEventListener('click', fn, false);
  elm.removeEventListener('click', fn, false);

  elm.click();
  jsUnit.assertNull(test);

  elm.parentNode.removeChild(elm);
});

jsUnit.add("Event.type", function()
{
  var elm = new_input(), type;
  elm.addEventListener('click', function(evt) { type = evt.type; }, false);
  elm.click();
  jsUnit.assertEquals(type, 'click');
  elm.parentNode.removeChild(elm);
});

jsUnit.add("Event bubbling", function()
{
  var elm = new_input(), test;
  function fn(evt) { test = false; }
  
  elm.addEventListener('click', function(evt) { test = true; }, false);
  document.body.addEventListener('click', fn, false);
  
  elm.click();
  jsUnit.assertFalse(test);
  
  elm.parentNode.removeChild(elm);
  document.body.removeEventListener('click', fn, false);
});

jsUnit.add("Event.stopPropagation()", function()
{
  var elm  = new_input();
  var test = null;
  
  function fn(evt) { test = 1; }
  
  elm.addEventListener('click', function(evt) { test = true; evt.stopPropagation(); }, false);
  elm.addEventListener('click', function(evt) { test = false; }, false);
  document.body.addEventListener('click', fn, false);

  elm.click();
  jsUnit.assertFalse(test);

  elm.parentNode.removeChild(elm);
  document.body.removeEventListener('click', fn, false);
});

if (Element.prototype.clearEvents)
{
  jsUnit.add("Element.clearEvents()", function()
  {
    var elm  = new_input();
    var test = null;

    elm.addEventListener('click', function(evt) { test = true;  }, false);
    elm.addEventListener('click', function(evt) { test = false; }, false);
    elm.clearEvents();

    elm.click();
    jsUnit.assertNull(test);

    elm.parentNode.removeChild(elm);
  });
  
  /*
  jsUnit.add("throwing an error musn't stop further listeners to be called", function()
  {
    var elm  = new_input();
    var test = null;
    
    elm.addEventListener('click', function()
    {
      test = true;
      throw new Error("This ERROR IS EXPECTED and shouldn't stop calling any further listener.");
    }, false);
    elm.addEventListener('click', function() { test = false; }, false);
    
    elm.click();
    jsUnit.assertFalse(test);
    
    elm.parentNode.removeChild(elm);
  });
  */
}

jsUnit.run();

</script>

</body>
</html>
