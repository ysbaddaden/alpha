<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.1//EN" "http://www.w3.org/TR/xhtml11/DTD/xhtml11.dtd">
<html xmlns="http://www.w3.org/1999/xhtml" xml:lang="fr">
<head>
	<meta http-equiv="X-UA-Compatible" content="IE=edge" />
	<link rel="stylesheet" type="text/css" href="base.css"/>
</head>
<body>

<h1>DOM Events</h1>

<script type="text/javascript" src="unit.js"></script>
<script type="text/javascript" src="loader.js"></script>
<script type="text/javascript">
load_alpha('..');
</script>

<script src="http://getfirebug.com/releases/lite/1.2/firebug-lite-compressed.js"></script>

<script type="text/javascript">

new Unit.TestCase('events',
{
  setup: function()
  {
    this.input = document.createElement('input');
    this.input.style.visibility = 'hidden';
    document.body.appendChild(this.input);
  },

  teardown: function() {
    document.body.removeChild(this.input);
  },

  test_event_must_be_prototyped: function() {
    this.assertEqual('object', typeof Event.prototype);
  },

  test_window_addEventListener: function() {
    this.assertTypeOf('function', window.addEventListener);
  },

  test_document_body_addEventListener: function() {
    this.assertTypeOf('function', document.body.addEventListener);
  },

  test_document_documentElement_addEventListener: function() {
    this.assertTypeOf('function', document.documentElement.addEventListener);
  },

  test_addEventListener_with_one_listener: function()
  {
    var test;
    this.input.addEventListener('click', function() { test = true }, false);
    this.input.click();
    this.assertTrue(test);
  },

  test_addEventListener_with_many_listeners: function()
  {
    var test = 0;
    this.input.addEventListener('click', function() { test += 1 }, false);
    this.input.addEventListener('click', function() { test += 2 }, false);
    this.input.click();
    this.assertEqual(3, test);
  },

  test_removeEventListener: function()
  {
    var test = null, fn = function() { test = true }
    this.input.addEventListener('click', fn, false);
    this.input.removeEventListener('click', fn, false);
    this.input.click();
    this.assertNull(test);
  },

  test_event_type: function()
  {
    var type;
    this.input.addEventListener('click', function(evt) { type = evt.type }, false);
    this.input.click();
    this.assertEqual(type, 'click');
  },

  test_event_bubbling: function()
  {
    var test, fn = function(evt) { test = false }
    
    this.input.addEventListener('click', function(evt) { test = true }, false);
    document.body.addEventListener('click', fn, false);
    this.input.click();
    this.assertFalse(test);
    
    document.body.removeEventListener('click', fn, false);
  },

  test_stopPropagation: function()
  {
    var test = null;
    
    function fn(evt) { test = 1 }
    
    this.input.addEventListener('click', function(evt) { test = true; evt.stopPropagation(); }, false);
    this.input.addEventListener('click', function(evt) { test = false; }, false);
    document.body.addEventListener('click', fn, false);
    
    this.input.click();
    this.assertFalse(test);
    
    document.body.removeEventListener('click', fn, false);
  },

  test_clearEvents: function()
  {
    if (Element.prototype.clearEvents)
    {
      var test = null;
      this.input.addEventListener('click', function(evt) { test = true  }, false);
      this.input.addEventListener('click', function(evt) { test = false }, false);
      this.input.clearEvents();
      this.input.click();
      this.assertNull(test);
    }
  },

  test_throwing_an_error_musnt_stop_further_listeners: function()
  {
    var test = null;
    
    this.input.addEventListener('click', function()
    {
      test = true;
      throw new Error("This ERROR IS EXPECTED, please discard.");
    }, false);
    
    this.input.addEventListener('click', function() { test = false }, false);
    this.input.click();
    this.assertFalse(test);
  },

  test_addEventListener_with_custom_event: function()
  {
    this.async();
    
    var self = this;
    this.input.addEventListener('custom', function(event)
    {
      self.sync(function() {
        this.assertEqual('custom', event.type);
      });
    }, false);
    
    var e = document.createEvent('Event');
    e.initEvent('custom', true, true);
    this.assertTrue(this.input.dispatchEvent(e));
  },
  
  test_removeEventListener_with_custom_event: function()
  {
    this.async();
    
    var self = this, test = null;
    var fn = function(event) { test = true }
    
    this.input.addEventListener('custom', fn, false);
    this.input.addEventListener('custom', function(event)
    {
      self.sync(function() {
        this.assertNull(test);
      });
    }, false);
    this.input.removeEventListener('custom', fn, false);
    
    var e = document.createEvent('HTMLEvents');
    e.initEvent('custom', true, true);
    this.assertTrue(this.input.dispatchEvent(e));
  }
});

Unit.HtmlRunner.run();

</script>

</body>
</html>
